# Орхидея

В данном разделе описан специальный объект Кипариса – Орхидея, данный объект позволяет делать интроспекцию различных компонент кластера через стандартное API Кипариса.

## Устройство Орхидеи

Орхидея по своей сути состоит из двух частей:
  1. Сервис Орхидеи внутри процесса, который порождает дерево из runtime-информации;
  2. Специальный узел в Кипарисе, который ссылается на RPC-адрес процесса.

Сервис Орихидеи содержит под собой `TYPathService`, который реализует доступ к различной информации внутри процесса.

При выполнении читающего запроса, который проходит через узел Орхидеи, происходит следующее: мастер-сервер данный читающий запрос транслирует в сервис Орхидеи в удаленном процессе с суффиксом пути, который еще не был разрезолвлен. Полученный ответ затем передается стороне, задающей запрос.

Обычно сервисы выставляют в Орхидее следующую информацию:
 - `config` – статический конфиг сервиса
 - `monitoring` – информация из подсистемы профайлинга, например, данные из `RefCounterTracker`
 - `sensors` – информация о сигналах, собираемых для мониторинга
 - `service` – общая информация о сервисе: версия запущенного бинарника, время старта процесса и пр.

Также большинство сервисов выставляет узел, одноименный названию сервиса, который содержит специфичную для данного сервиса информацию. Например, в Орхидее планировщика есть узел `scheduler`.

Примеры работы с Орхидеей:

```bash
$ yt list //sys/scheduler/orchid
config
monitoring
scheduler
sensors
service
```

```bash
$ yt get //sys/scheduler/orchid/service
{
    "version" = "23.1.11146768-stable-ya~fa8c90ccf92c4a64";
    "name" = "scheduler";
    "start_time" = "2023-09-15T09:37:48.669147Z";
    "build_time" = "2023-09-08T13:54:51.000000Z";
    "build_host" = "yt-tc-16.vla.yp-c.yandex.net";
}
```

{% endcut %}

## Узел Орхидеи

Узел Орхидеи представляет из себя специальный объект типа `orchid`, который как правило создается самими сервисами по факту их регистрации в мастере.

Узел имеет следующие атрибуты, задающие адрес сервиса и свойства подключения к нему:
 - `remote_addresses` – словарь адресов сервиса для подключения, в данном словаре должен присутствовать `default` значение, именно оно будет использоваться по умолчанию, если у сервисов не настроены особые приоритеты для выбора сети
 - `remote_root` – путь, от которого должна начинаться Орхидея с точки зрения сервиса Орхидеи процесса (по умолчанию `/`)
 - `timeout` – общий таймаут на исполнение запроса Орхидеей сервиса
 - `retry_attempts`, `retry_backoff_time`, `retry_timeout` – настройки ретраев

Например каждый контроллер-агент имеет свою Орхидею:
```
$ yt get //sys/controller_agents/instances --proxy hume
{
    "sas2-2060-controller-agent-hume.man-pre.yp-c.yandex.net:9014" = {
        "orchid" = #;
        "lock" = {};
    };
    "sas2-2059-controller-agent-hume.man-pre.yp-c.yandex.net:9014" = {
        "orchid" = #;
        "lock" = {};
    };
    "sas2-2058-controller-agent-hume.man-pre.yp-c.yandex.net:9014" = {
        "orchid" = #;
        "lock" = {};
    };
}
```

В случае сервиса планировщика узел Орхидеи один и он указывает на активный инстанс планировщика. Это достигается за счет того, что активный планирощик записывает свой адрес в атрибут `remote_addresses` у узла Орхидеи.
``` 
$ yt get //sys/scheduler/orchid/@remote_addresses
{
    "default" = "sas2-2059-scheduler-hume.man-pre.yp-c.yandex.net:9011";
}
```
